{% extends 'parser/html/base.html' %}

{% block content %}
<div class="parser-container">
    <div class="parser-header">
        <h1>–ü–∞—Ä—Å–µ—Ä –≤–∞–∫–∞–Ω—Å–∏–π</h1>
        <p>–£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–±–æ—Ä –≤–∞–∫–∞–Ω—Å–∏–π</p>
    </div>

    <div class="parser-form-container">
        <form id="parser-form" class="parser-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="query" class="form-label">
                    –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:
                </label>
                <input type="text" id="query" name="query" value="Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫" 
                       class="form-control" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é –∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞">
                <small class="form-hint">–ù–∞–ø—Ä–∏–º–µ—Ä: Python, JavaScript, Data Scientist</small>
            </div>
            
            <div class="form-group">
                <label for="pages" class="form-label">
                    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü:
                </label>
                <input type="number" id="pages" name="pages" min="1" max="10" value="2" 
                       class="form-control" required>
                <small class="form-hint">–ö–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ 50 –≤–∞–∫–∞–Ω—Å–∏–π</small>
            </div>
            
            <button type="submit" class="btn btn-primary btn-large" id="parse-button">
                –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
            </button>
        </form>
        
        <div class="parser-info">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <ul>
                <li>–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ API HH.ru</li>
                <li>–ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ª–µ–≥–∞–ª–µ–Ω</li>
                <li>–°–æ–±–ª—é–¥–∞—é—Ç—Å—è –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤</li>
                <li>–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É SQLite</li>
            </ul>
        </div>
    </div>
    
    <div id="results" class="results-container"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('parser-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const resultsDiv = document.getElementById('results');
    const parseButton = document.getElementById('parse-button');
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    parseButton.disabled = true;
    parseButton.innerHTML = '‚è≥ –ü–∞—Ä—Å–∏–Ω–≥...';
    
    resultsDiv.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <h3>–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω</h3>
            <p>–ò–¥–µ—Ç —Å–±–æ—Ä –≤–∞–∫–∞–Ω—Å–∏–π —Å HH.ru, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</p>
            <p>–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü</p>
        </div>
    `;

    fetch('{% url "parser" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            resultsDiv.innerHTML = `
                <div class="success">
                    <div class="success-icon"></div>
                    <h3>–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h3>
                    <p><strong>${data.message}</strong></p>
                    <div class="success-stats">
                        <span class="stat">–ù–∞–π–¥–µ–Ω–æ: ${data.found}</span>
                        <span class="stat">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${data.saved}</span>
                    </div>
                    <div class="success-actions">
                        <a href="{% url 'vacancy_list' %}" class="btn btn-success">
                            üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≤–∞–∫–∞–Ω—Å–∏–∏
                        </a>
                        <button onclick="location.reload()" class="btn btn-outline">
                            üîÑ –ù–æ–≤—ã–π –ø–æ–∏—Å–∫
                        </button>
                    </div>
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="error">
                    <div class="error-icon"></div>
                    <h3>–û—à–∏–±–∫–∞</h3>
                    <p>${data.error}</p>
                    <button onclick="location.reload()" class="btn btn-outline">
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `
            <div class="error">
                <div class="error-icon"></div>
                <h3>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h3>
                <p>${error.message}</p>
                <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</p>
            </div>
        `;
    })
    .finally(() => {
        parseButton.disabled = false;
        parseButton.innerHTML = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥';
    });
});
</script>
{% endblock %}