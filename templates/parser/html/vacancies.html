{% extends 'parser/html/base.html' %}

{% block content %}
<div class="vacancies-container">
    <div class="vacancies-header">
        <h1>üìã –°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π</h1>
        
        <!-- –ë–ª–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        {% if has_active_filters %}
        <div class="active-filters" style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #27ae60;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #2c5530;">üéØ –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</h4>
                <a href="/vacancies/" class="btn btn-outline btn-small" style="text-decoration: none;">
                    ‚ùå –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
                </a>
            </div>
            <div class="filter-tags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                {% if search_query %}
                <span class="filter-tag" style="background: #3498db; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üîç –ü–æ–∏—Å–∫: "{{ search_query }}"
                </span>
                {% endif %}
                {% if keywords %}
                <span class="filter-tag" style="background: #9b59b6; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üìù –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: "{{ keywords }}"
                </span>
                {% endif %}
                {% if min_salary %}
                <span class="filter-tag" style="background: #e74c3c; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üí∞ –ú–∏–Ω. –∑–∞—Ä–ø–ª–∞—Ç–∞: {{ min_salary }} ‚ÇΩ
                </span>
                {% endif %}
                {% if experience and experience != '' %}
                <span class="filter-tag" style="background: #f39c12; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üìä –û–ø—ã—Ç:
                    {% if experience == 'no' %}–ë–µ–∑ –æ–ø—ã—Ç–∞
                    {% elif experience == '1-3' %}1-3 –≥–æ–¥–∞
                    {% elif experience == '3-6' %}3-6 –ª–µ—Ç
                    {% elif experience == '6+' %}–ë–æ–ª–µ–µ 6 –ª–µ—Ç
                    {% else %}{{ experience }}{% endif %}
                </span>
                {% endif %}
                {% if employment and employment != '' %}
                <span class="filter-tag" style="background: #2ecc71; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üíº –ó–∞–Ω—è—Ç–æ—Å—Ç—å:
                    {% if employment == 'full' %}–ü–æ–ª–Ω–∞—è
                    {% elif employment == 'part' %}–ß–∞—Å—Ç–∏—á–Ω–∞—è
                    {% elif employment == 'remote' %}–£–¥–∞–ª–µ–Ω–Ω–∞—è
                    {% elif employment == 'project' %}–ü—Ä–æ–µ–∫—Ç–Ω–∞—è
                    {% else %}{{ employment }}{% endif %}
                </span>
                {% endif %}
                {% if min_experience_years %}
                <span class="filter-tag" style="background: #34495e; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    ‚è≥ –ú–∏–Ω. –æ–ø—ã—Ç: {{ min_experience_years }} –ª–µ—Ç
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="vacancies-controls">
            <form method="get" class="search-form">
                <div class="search-group">
                    <input type="text" name="search" value="{{ search_query }}"
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º..." class="search-input">
                    <button type="submit" class="btn btn-primary">üîç –ù–∞–π—Ç–∏</button>
                </div>
            </form>

            <div class="vacancies-stats">
                <span class="stat-badge">–ù–∞–π–¥–µ–Ω–æ: {{ vacancies_count }}</span>
                {% if has_active_filters %}
                <span class="stat-badge" style="background: #27ae60;">üîç –° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏</span>
                {% endif %}
                <a href="{% url 'parser' %}" class="btn btn-outline">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏</a>
            </div>
        </div>
    </div>

    {% if vacancies %}
        <div class="vacancies-list">
            {% for vacancy in vacancies %}
            <div class="vacancy-item">
                <div class="vacancy-header">
                    <h3 class="vacancy-title">
                        <a href="{{ vacancy.link }}" target="_blank" class="vacancy-link">
                            {{ vacancy.title }}
                        </a>
                    </h3>
                    <span class="vacancy-salary">{{ vacancy.salary }}</span>
                </div>

                <div class="vacancy-company">{{ vacancy.company }}</div>

                <div class="vacancy-meta">
                    <span class="meta-item">
                        üìä –û–ø—ã—Ç: {{ vacancy.get_experience_display }}
                    </span>
                    <span class="meta-item">
                        üíº {{ vacancy.get_employment_display }}
                    </span>
                    <span class="meta-item">
                        üìÖ {{ vacancy.created_at|date:"d.m.Y H:i" }}
                    </span>
                </div>

                {% if vacancy.skills %}
                <div class="vacancy-skills">
                    <strong>üõ†Ô∏è –ù–∞–≤—ã–∫–∏:</strong>
                    <div class="skills-list">
                        {{ vacancy.skills }}
                    </div>
                </div>
                {% endif %}

                {% if vacancy.description %}
                <div class="vacancy-description">
                    <strong>üìù –û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                    <p>{{ vacancy.description|truncatewords:50 }}</p>
                </div>
                {% endif %}

                <div class="vacancy-actions">
                    <a href="{{ vacancy.link }}" target="_blank" class="btn btn-outline btn-small">
                        üîó –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ HH.ru
                    </a>
                    <button class="btn btn-primary btn-small"
                            onclick="generateCoverLetter({{ vacancy.id }})">
                        ‚úâÔ∏è –°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if vacancies_count > 20 %}
        <div class="pagination" style="text-align: center; margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
            <p style="margin: 0; color: #666;">
                üìÑ –ü–æ–∫–∞–∑–∞–Ω–æ <strong>{{ vacancies_count }}</strong> –≤–∞–∫–∞–Ω—Å–∏–π
                {% if has_active_filters %} —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏{% endif %}
            </p>
        </div>
        {% endif %}

    {% else %}
        <div class="no-vacancies">
            <div class="empty-state">
                <h3>üòî –í–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>
                    {% if has_active_filters %}
                    –ü–æ –≤–∞—à–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏—è –ø–æ–∏—Å–∫–∞.
                    {% else %}
                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–∞—Ä—Å–µ—Ä –¥–ª—è —Å–±–æ—Ä–∞ –≤–∞–∫–∞–Ω—Å–∏–π
                    {% endif %}
                </p>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                    <a href="{% url 'parser' %}" class="btn btn-primary">
                        üîç –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–µ—Ä
                    </a>
                    {% if has_active_filters %}
                    <a href="/vacancies/" class="btn btn-outline">
                        ‚ùå –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
function generateCoverLetter(vacancyId) {
    fetch('/api/generate-letter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            vacancy_id: vacancyId,
            template_type: 'standard'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∏—Å—å–º–æ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head><title>–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ</title></head>
                    <body style="font-family: Arial, sans-serif; padding: 2rem;">
                        <pre style="white-space: pre-wrap; font-size: 14px;">${data.letter_content}</pre>
                        <button onclick="window.print()" style="margin-top: 1rem; padding: 0.5rem 1rem;">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                    </body>
                </html>
            `);
        } else {
            alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞: ' + data.error);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞');
    });
}

function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}
</script>

<style>
.filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.vacancy-item {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.vacancy-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
</style>
{% endblock %}