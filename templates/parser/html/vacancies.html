<!-- templates/parser/html/vacancies.html -->
{% extends 'parser/html/base.html' %}

{% block content %}
<div class="vacancies-container">
    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="debug-panel" style="background: #e3f2fd; padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.8rem; color: #1565c0;">
        üîç –û—Ç–ª–∞–¥–∫–∞: –ù–∞–π–¥–µ–Ω–æ {{ vacancies_count }} –≤–∞–∫–∞–Ω—Å–∏–π | –ü–æ–∫–∞–∑–∞–Ω–æ: {{ vacancies|length }} –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    </div>

    <div class="vacancies-header">
        <h1>üìã –°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π</h1>

        <!-- –ë–ª–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        {% if has_active_filters %}
        <div class="active-filters" style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #27ae60;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; color: #2c5530;">üéØ –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</h4>
                <a href="/vacancies/" class="btn btn-outline btn-small" style="text-decoration: none;">
                    ‚ùå –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
                </a>
            </div>
            <div class="filter-tags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                {% if search_query %}
                <span class="filter-tag" style="background: #3498db; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üîç –ü–æ–∏—Å–∫: "{{ search_query }}"
                </span>
                {% endif %}
                {% if keywords %}
                <span class="filter-tag" style="background: #9b59b6; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üìù –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: "{{ keywords }}"
                </span>
                {% endif %}
                {% if min_salary %}
                <span class="filter-tag" style="background: #e74c3c; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üí∞ –ú–∏–Ω. –∑–∞—Ä–ø–ª–∞—Ç–∞: {{ min_salary }} ‚ÇΩ
                </span>
                {% endif %}
                {% if experience and experience != '' %}
                <span class="filter-tag" style="background: #f39c12; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üìä –û–ø—ã—Ç:
                    {% if experience == 'no' %}–ë–µ–∑ –æ–ø—ã—Ç–∞
                    {% elif experience == '1-3' %}1-3 –≥–æ–¥–∞
                    {% elif experience == '3-6' %}3-6 –ª–µ—Ç
                    {% elif experience == '6+' %}–ë–æ–ª–µ–µ 6 –ª–µ—Ç
                    {% else %}{{ experience }}{% endif %}
                </span>
                {% endif %}
                {% if employment and employment != '' %}
                <span class="filter-tag" style="background: #2ecc71; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    üíº –ó–∞–Ω—è—Ç–æ—Å—Ç—å:
                    {% if employment == 'full' %}–ü–æ–ª–Ω–∞—è
                    {% elif employment == 'part' %}–ß–∞—Å—Ç–∏—á–Ω–∞—è
                    {% elif employment == 'remote' %}–£–¥–∞–ª–µ–Ω–Ω–∞—è
                    {% elif employment == 'project' %}–ü—Ä–æ–µ–∫—Ç–Ω–∞—è
                    {% else %}{{ employment }}{% endif %}
                </span>
                {% endif %}
                {% if min_experience_years %}
                <span class="filter-tag" style="background: #34495e; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.875rem;">
                    ‚è≥ –ú–∏–Ω. –æ–ø—ã—Ç: {{ min_experience_years }} –ª–µ—Ç
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="vacancies-controls">
            <form method="get" class="search-form">
                <div class="search-group">
                    <input type="text" name="search" value="{{ search_query }}"
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º..." class="search-input">
                    <button type="submit" class="btn btn-primary">üîç –ù–∞–π—Ç–∏</button>
                </div>
            </form>

            <div class="vacancies-stats">
                <span class="stat-badge">–í—Å–µ–≥–æ: {{ vacancies_count }}</span>
                <span class="stat-badge" style="background: #3498db;">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: {{ vacancies|length }}</span>
                {% if has_active_filters %}
                <span class="stat-badge" style="background: #27ae60;">üîç –° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏</span>
                {% endif %}
                <a href="{% url 'parser' %}" class="btn btn-outline">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏</a>
            </div>
        </div>
    </div>

    {% if vacancies %}
        <div class="vacancies-list">
            {% for vacancy in vacancies %}
            <div class="vacancy-item">
                <div class="vacancy-header">
                    <h3 class="vacancy-title">
                        <a href="{{ vacancy.link }}" target="_blank" class="vacancy-link">
                            {{ vacancy.title }}
                        </a>
                    </h3>
                    <span class="vacancy-salary">{{ vacancy.salary }}</span>
                </div>

                <div class="vacancy-company">üè¢ {{ vacancy.company }}</div>

                <div class="vacancy-meta">
                    <span class="meta-item">
                        üìä –û–ø—ã—Ç:
                        {% if vacancy.experience == 'no' %}–ù–µ—Ç –æ–ø—ã—Ç–∞
                        {% elif vacancy.experience == '1-3' %}1-3 –≥–æ–¥–∞
                        {% elif vacancy.experience == '3-6' %}3-6 –ª–µ—Ç
                        {% elif vacancy.experience == '6+' %}–ë–æ–ª–µ–µ 6 –ª–µ—Ç
                        {% else %}{{ vacancy.experience }}{% endif %}
                    </span>
                    <span class="meta-item">
                        üíº
                        {% if vacancy.employment == 'full' %}–ü–æ–ª–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å
                        {% elif vacancy.employment == 'part' %}–ß–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å
                        {% elif vacancy.employment == 'remote' %}–£–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞
                        {% elif vacancy.employment == 'project' %}–ü—Ä–æ–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞
                        {% else %}{{ vacancy.employment }}{% endif %}
                    </span>
                    <span class="meta-item">
                        üìÖ {{ vacancy.created_at|date:"d.m.Y H:i" }}
                    </span>
                </div>

                {% if vacancy.skills %}
                <div class="vacancy-skills">
                    <strong>üõ†Ô∏è –ù–∞–≤—ã–∫–∏:</strong>
                    <div class="skills-list">
                        {{ vacancy.skills }}
                    </div>
                </div>
                {% endif %}

                {% if vacancy.description %}
                <div class="vacancy-description">
                    <strong>üìù –û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                    <p>{{ vacancy.description|truncatewords:50 }}</p>
                </div>
                {% endif %}

                <div class="vacancy-actions">
                    <a href="{{ vacancy.link }}" target="_blank" class="btn btn-outline btn-small">
                        üîó –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ HH.ru
                    </a>
                    <button class="btn btn-primary btn-small"
                            onclick="generateCoverLetter({{ vacancy.id }})">
                        ‚úâÔ∏è –°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- –ü–ê–ì–ò–ù–ê–¶–ò–Ø -->
        {% if page_obj.has_other_pages %}
        <div class="pagination" style="text-align: center; margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
            <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                       class="btn btn-outline">
                        ‚Üê –ù–∞–∑–∞–¥
                    </a>
                {% endif %}

                <span class="current-page" style="padding: 0.5rem 1rem; background: white; border-radius: 6px; font-weight: 500;">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                       class="btn btn-outline">
                        –í–ø–µ—Ä–µ–¥ ‚Üí
                    </a>
                {% endif %}
            </div>

            <div style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                üìÑ –ü–æ–∫–∞–∑–∞–Ω–æ {{ vacancies|length }} –∏–∑ {{ vacancies_count }} –≤–∞–∫–∞–Ω—Å–∏–π
            </div>
        </div>
        {% endif %}

    {% else %}
        <div class="no-vacancies">
            <div class="empty-state">
                <h3>üòî –í–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>
                    {% if has_active_filters %}
                    –ü–æ –≤–∞—à–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —É—Å–ª–æ–≤–∏—è –ø–æ–∏—Å–∫–∞.
                    {% else %}
                    –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–∞—Ä—Å–µ—Ä –¥–ª—è —Å–±–æ—Ä–∞ –≤–∞–∫–∞–Ω—Å–∏–π.
                    {% endif %}
                </p>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                    <a href="{% url 'parser' %}" class="btn btn-primary">
                        üîç –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–µ—Ä
                    </a>
                    {% if has_active_filters %}
                    <a href="/vacancies/" class="btn btn-outline">
                        ‚ùå –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<style>
.debug-panel {
    font-family: monospace;
    border: 1px solid #90caf9;
}

.vacancy-item {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    border: 1px solid #e0e0e0;
    transition: all 0.3s ease;
}

.vacancy-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-color: #3498db;
}

.vacancy-link {
    color: #2c3e50;
    text-decoration: none;
    font-weight: 600;
}

.vacancy-link:hover {
    color: #3498db;
    text-decoration: underline;
}

.vacancy-salary {
    background: #27ae60;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-weight: 600;
    font-size: 0.875rem;
}

.skills-list {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 6px;
    margin-top: 0.5rem;
    border-left: 3px solid #3498db;
    font-size: 0.9rem;
}

.vacancy-meta {
    display: flex;
    gap: 1.5rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.meta-item {
    color: #666;
    font-size: 0.875rem;
}

.vacancy-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.pagination {
    border: 1px solid #e0e0e0;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function generateCoverLetter(vacancyId) {
    fetch('/api/generate-letter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            vacancy_id: vacancyId,
            template_type: 'standard'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∏—Å—å–º–æ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head><title>–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ</title></head>
                    <body style="font-family: Arial, sans-serif; padding: 2rem;">
                        <pre style="white-space: pre-wrap; font-size: 14px;">${data.letter_content}</pre>
                        <button onclick="window.print()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                    </body>
                </html>
            `);
        } else {
            alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞: ' + data.error);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞');
    });
}

function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞–∫–∞–Ω—Å–∏—è—Ö:');
    console.log('- –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ:', {{ vacancies_count }});
    console.log('- –ù–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:', {{ vacancies|length }});
    console.log('- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:', {{ has_active_filters|yesno:"–¥–∞,–Ω–µ—Ç" }});

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –¥–ª—è –≤–∞–∫–∞–Ω—Å–∏–π
    const vacancyItems = document.querySelectorAll('.vacancy-item');
    vacancyItems.forEach(item => {
        item.style.cursor = 'pointer';
        item.addEventListener('click', function(e) {
            // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É
            if (!e.target.closest('.btn')) {
                const link = this.querySelector('.vacancy-link');
                if (link) {
                    window.open(link.href, '_blank');
                }
            }
        });
    });
});
</script>
{% endblock %}